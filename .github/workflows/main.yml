name: ğŸ“Š Progress Bar & README Update

on:
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update README'
        required: false
        default: 'false'
        type: boolean
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶æ›´æ–°ä¸€æ¬¡
  push:
    branches: [ main ]
    paths: 
      - 'index.js'
      - '.github/workflows/*.yml'

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: ğŸ”„ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        
    - name: ğŸš€ Generate Dynamic Content
      run: |
        # ç”ŸæˆåŠ¨æ€å†…å®¹åˆ°ä¸´æ—¶æ–‡ä»¶
        node index.js > dynamic_content.tmp
        
    - name: ğŸ“ Replace Dynamic Section in README
      run: |
        # ä½¿ç”¨sedå‘½ä»¤æ›¿æ¢ä¸¤ä¸ªæ ‡è®°ä¹‹é—´çš„å†…å®¹
        # æ³¨æ„ï¼šç¡®ä¿ä½ çš„READMEä¸­å­˜åœ¨ <!-- åŠ¨æ€å†…å®¹å¼€å§‹ --> å’Œ <!-- åŠ¨æ€å†…å®¹ç»“æŸ --> æ ‡è®°
        sed -i -e '/<!-- åŠ¨æ€å†…å®¹å¼€å§‹ -->/,/<!-- åŠ¨æ€å†…å®¹ç»“æŸ -->/{//!d;}' README.md
        sed -i -e '/<!-- åŠ¨æ€å†…å®¹å¼€å§‹ -->/r dynamic_content.tmp' README.md
        
    - name: ğŸ“Š Check for Changes
      id: check_changes
      run: |
        if git diff --quiet README.md; then
          echo "changes_detected=false" >> $GITHUB_OUTPUT
        else
          echo "changes_detected=true" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸš€ Commit and Push Changes
      if: steps.check_changes.outputs.changes_detected == 'true' || github.event.inputs.force_update == 'true'
      run: |
        git config --local user.name 'github-actions[bot]'
        git config --local user.email '41898282+github-actions[bot]@users.noreply.github.com'
        git add README.md
        git commit -m "ğŸ¤– Auto-update dynamic content - $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
        git push
        
    - name: ğŸ§¹ Cleanup
      if: always()
      run: rm -f dynamic_content.tmp
