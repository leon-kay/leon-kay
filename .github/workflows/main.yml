name: ğŸ“Š Progress Bar & README Update

on:
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update README'
        required: false
        default: 'false'
        type: boolean
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶æ›´æ–°ä¸€æ¬¡
  push:
    branches: [ main ]
    paths: 
      - 'index.js'
      - '.github/workflows/*.yml'

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    continue-on-error: false  # æ˜ç¡®é”™è¯¯ç»ˆæ­¢
    
    steps:
    - name: ğŸ”„ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        
    - name: ğŸš€ Generate Dynamic Content
      run: |
        # ç”ŸæˆåŠ¨æ€å†…å®¹åˆ°ä¸´æ—¶æ–‡ä»¶ï¼ˆç¡®ä¿å‘½ä»¤æˆåŠŸæ‰§è¡Œï¼‰
        node index.js > dynamic_content.tmp || { echo "ç”ŸæˆåŠ¨æ€å†…å®¹å¤±è´¥"; exit 1; }
        
    - name: ğŸ“ Replace Dynamic Section in README
      run: |
        # ç¡®ä¿ README.md å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºï¼ˆé¿å…åç»­å‘½ä»¤å¤±è´¥ï¼‰
        if [ ! -f "README.md" ]; then
          echo "åˆ›å»ºç©º README.md"
          touch README.md
        fi
        
        # ä½¿ç”¨ sed æ›¿æ¢åŠ¨æ€å†…å®¹ï¼ˆå…¼å®¹ Ubuntu çš„ sed è¯­æ³•ï¼‰
        # 1. åˆ é™¤æ ‡è®°é—´çš„æ—§å†…å®¹ï¼ˆä¿ç•™æ ‡è®°ï¼‰
        sed -i '/<!-- åŠ¨æ€è¿›åº¦çŸ©é˜µå¼€å§‹ -->/,/<!-- åŠ¨æ€è¿›åº¦çŸ©é˜µç»“æŸ -->/{//!d;}' README.md
        # 2. åœ¨å¼€å§‹æ ‡è®°åæ’å…¥æ–°å†…å®¹
        sed -i -e '/<!-- åŠ¨æ€è¿›åº¦çŸ©é˜µå¼€å§‹ -->/r dynamic_content.tmp' README.md || { echo "æ›¿æ¢å†…å®¹å¤±è´¥"; exit 1; }
        
    - name: ğŸ“Š Check for Changes
      id: check_changes
      run: |
        # æ£€æŸ¥ README æ˜¯å¦æœ‰å˜åŒ–ï¼ˆå¿½ç•¥ç©ºæ ¼/ç©ºè¡Œå·®å¼‚ï¼‰
        if git diff --ignore-all-space --quiet README.md; then
          echo "changes_detected=false" >> $GITHUB_OUTPUT
        else
          echo "changes_detected=true" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸš€ Commit and Push Changes
      if: steps.check_changes.outputs.changes_detected == 'true' || github.event.inputs.force_update == 'true'
      run: |
        # ç¡®ä¿é…ç½®ç”¨æˆ·ä¿¡æ¯
        git config --local user.name 'github-actions[bot]'
        git config --local user.email '41898282+github-actions[bot]@users.noreply.github.com'
        
        # å¼ºåˆ¶æ·»åŠ  README.mdï¼ˆç¡®ä¿ä¿®æ”¹è¢«è·Ÿè¸ªï¼‰
        git add README.md
        
        # æäº¤ï¼ˆå…è®¸ç©ºæäº¤ï¼Œé¿å…æ— å†…å®¹æ—¶å¤±è´¥ï¼‰
        git commit -m "ğŸ¤– Auto-update dynamic content - $(date -u +"%Y-%m-%d %H:%M:%S UTC")" --allow-empty || { echo "æäº¤å¤±è´¥"; exit 1; }
        git push origin main || { echo "æ¨é€å¤±è´¥"; exit 1; }
        
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼Œé¿å…æ®‹ç•™æœªè·Ÿè¸ªæ–‡ä»¶
        rm -f dynamic_content.tmp
