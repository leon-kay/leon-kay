name: ğŸ“Š Progress Bar & README Update

on:
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update README'
        required: false
        default: 'false'
        type: boolean
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶æ‰§è¡Œä¸€æ¬¡
  push:
    branches: [ main ]
    paths: 
      - 'index.js'
      - '.github/workflows/*.yml'

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
    - name: ğŸ”„ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        
    - name: ğŸ”§ Check if index.js exists
      run: |
        if [ ! -f index.js ]; then
          echo "âŒ index.js not found!"
          echo "Creating a basic index.js file..."
          cat > index.js << 'EOF'
        // Basic progress bar generator
        const now = new Date();
        const start = new Date(now.getFullYear(), 0, 1);
        const end = new Date(now.getFullYear() + 1, 0, 1);
        const progress = ((now - start) / (end - start)) * 100;
        
        const progressBar = 'â–ˆ'.repeat(Math.floor(progress / 5)) + 'â–¶' + 'â–‘'.repeat(20 - Math.floor(progress / 5));
        
        console.log(`# ğŸŒŒ Year Progress 2025
        
        **âš¡ Progress:** \`${progressBar}\` **${progress.toFixed(2)}%**
        
        ğŸ“… **Days:** ${Math.floor((now - start) / (1000 * 60 * 60 * 24))}/365  
        â³ **Remaining:** ${Math.floor((end - now) / (1000 * 60 * 60 * 24))} days  
        
        *Last updated: ${now.toISOString()}*`);
        EOF
        fi
        
    - name: ğŸš€ Generate README Content
      run: |
        echo "ğŸ”§ Running index.js..."
        node index.js > README_new.md
        echo "âœ… Generated new README content"
        
    - name: ğŸ“Š Check for Changes
      id: check_changes
      run: |
        if [ ! -f README.md ]; then
          echo "ğŸ“ README.md doesn't exist, will create it"
          echo "changes_detected=true" >> $GITHUB_OUTPUT
        elif ! diff -q README.md README_new.md > /dev/null 2>&1; then
          echo "changes_detected=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ Changes detected in README.md"
        else
          echo "changes_detected=false" >> $GITHUB_OUTPUT
          echo "âœ… No changes detected"
        fi
        
    - name: ğŸ“ Update README
      if: steps.check_changes.outputs.changes_detected == 'true' || github.event.inputs.force_update == 'true'
      run: |
        mv README_new.md README.md
        echo "ğŸ“„ README.md updated successfully"
        
    - name: ğŸš€ Commit and Push Changes
      if: steps.check_changes.outputs.changes_detected == 'true' || github.event.inputs.force_update == 'true'
      run: |
        git config --local user.name 'github-actions[bot]'
        git config --local user.email '41898282+github-actions[bot]@users.noreply.github.com'
        
        TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        git add README.md
        git commit -m "ğŸ¤– Auto-update README.md - ${TIMESTAMP}" \
                   -m "Updated by GitHub Actions workflow" \
                   -m "Triggered by: ${{ github.event_name }}"
        git push
        
    - name: ğŸ“ˆ Success Message
      if: steps.check_changes.outputs.changes_detected == 'true'
      run: |
        echo "âœ… README.md has been updated successfully!"
        echo "ğŸ• Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
        
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        rm -f README_new.md
